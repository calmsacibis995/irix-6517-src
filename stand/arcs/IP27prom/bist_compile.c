/*
 * BIST compiler
 *
 *   Compiles bist_data.src input format into bist_data.c output format.
 */

#include <sys/types.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <ctype.h>

main(int argc, char **argv)
{
    char		buf[80], tmp[32], name[32], upper[32], field[32];
    char	       *s, *d;
    int			pos, totbits, bits, use, i;
    int			first = 1, curline = 0, done = 0;
    __uint64_t		data, value, mask;
    int			status_loc;
    int			bist_valid_loc;
    int			flush_d_lbist_war_loc;
    int			misr_loc;
    int			gram_res_loc;

    printf("/*\n"
	   " * This file is automatically generated.\n"
	   " * Do not edit (see bist_data.src).\n"
	   " */\n\n");

    while (1) {
	if (gets(buf) == 0) {
	    done = 1;
	    goto finish;
	}
	curline++;
	if (buf[0] == 0 || buf[0] == '#')
	    continue;
	s = buf;
	if (*s != ' ' && *s != '\t') {
	    if (! first) {
	    finish:
		if (pos & 63)
		    printf("\t0x%016llx,\n", data);
		printf("};\n\n");
		printf("#define %s_BITS %d\n", upper, totbits);
		printf("#define %s_DWORDS %d\n", upper, (totbits + 63) / 64);
		if (flush_d_lbist_war_loc >= 0)
		    printf("#define %s_FLUSH_D_LBIST_WAR %d\n", 
			upper, flush_d_lbist_war_loc);
                if (bist_valid_loc >= 0)
                    printf("#define %s_BIST_VALID_FLAG %d\n", 
			upper, bist_valid_loc);
		if (misr_loc >= 0)
		    printf("#define %s_MISR %d\n", upper, misr_loc);
		if (gram_res_loc >= 0)
		    printf("#define %s_GRAM_RESULTS %d\n", 
			upper, gram_res_loc);
		if (status_loc >= 0)
		    printf("#define %s_STATUS %d\n", upper, status_loc);
		printf("\n");
		if (done)
		    break;
	    }
	    d = name;
	    while (isalnum(*s) || *s == '_')
		*d++ = *s++;
	    *d = 0;
	    while (isspace(*s))
		s++;
	    totbits = atoi(s);
	    first = 0;
	    for (i = 0; name[i]; i++)
		upper[i] = toupper(name[i]);
	    upper[i] = 0;
	    printf("__uint64_t %s[] = {\n", name);
	    pos = 0;
	    data = 0;
	    bist_valid_loc = -1;
	    misr_loc = -1;
	    gram_res_loc = -1;
	    status_loc = -1;
	    flush_d_lbist_war_loc = -1;

	} else {
	    while (isspace(*s))
		s++;
	    d = field;
	    while (isalnum(*s) || *s == '_')
		*d++ = *s++;
	    *d = 0;
	    while (isspace(*s))
		s++;
	    if (*s++ != ':')
		goto bad;
	    bits = atoi(s);
	    while (*s && *s != '=')
		s++;
	    if (*s++ != '=')
		goto bad;
	    value = strtoull(s, 0, 0);

            if (strcmp(field, "bist_valid_flag") == 0)
                bist_valid_loc = pos;

	    if (strcmp(field, "MISR") == 0)
		misr_loc = pos;

	    if (strcmp(field, "gram_results") == 0)
		gram_res_loc = pos;

	    if (strcmp(field, "status") == 0)
		status_loc = pos;

	    if (strcmp(field, "flush_d_lbist_war") == 0)
		flush_d_lbist_war_loc = pos;

	    if ((pos & 63) + bits > 63) {
		use = 64 - (pos & 63);
		data |= value >> (bits - use);
		mask = (bits - use == 64) ? ~0ULL : (1ULL << bits - use) - 1;
		value &= mask;
		printf("\t0x%016llx,\n", data);
		bits -= use;
		pos += use;
		data = 0;
	    }

	    mask = (bits == 64) ? ~0ULL : (1ULL << bits) - 1;
	    data |= (value & mask) << (64 - (pos & 63) - bits);
	    pos += bits;
	}
    }

    exit(0);

 bad:

    fprintf(stderr, "Bad input on line %d\n", curline);
    exit(1);
}
