#
# make an efs root disk image for IP30 sable runs
#

RELEASEDEFS=/dev/null
include $(ROOT)/usr/include/make/$(PRODUCT)defs

SIZE=81920
SWAP=20480
DISKNAME=RootDev

# we should figure this out from the .workarea, but I'm lazy.
SRCTREE=/proj/kudzu/isms
ARCS=$(WORKAREA)/stand/arcs
BOOTAREA=$(ROOT)/usr/sysgen/$(CPUBOARD)$(SUBPRODUCT)boot


RootDev: rootdev dvh
	cp dvh $(DISKNAME)
	cat rootdev >> $(DISKNAME)
	dd bs=512 count=$(SWAP) if=/dev/zero >> $(DISKNAME)

proto.mr.fixed: Makefile proto.mr
	@sed -e "s%WORKAREA%$(WORKAREA)%" -e "s%SRCTREE%$(SRCTREE)%" -e "s%BOOTAREA%$(BOOTAREA)%" proto.mr > proto.mr.fixed

motd: .FORCE
	@echo RootDev generated by $(USER) in $(WORKAREA) at `date` > motd

Makedepend.rootdev: proto.mr.fixed
	@nawk 'BEGIN {print "rootdev: \\" }{if (length($$5) > 0 && substr($$5,0,1) == "/") print "\t" $$5 " \\"}' proto.mr.fixed > Makedepend.rootdev
	@echo "Makefile\n" >> Makedepend.rootdev

rootdev: Makedepend.rootdev Makefile inittab motd
	@echo
	@echo "Making sable disk -- assumes you are running on a 6.2 system,"
	@echo "and the following directories updated and built in your WORKAREA:"
	@echo "\tirix/cmd/hinv"
	@echo "\tirix/cmd/initpkg"
	@echo
	@rm -rf rootdev
	@touch rootdev
	/etc/mkfs -t efs rootdev $(SIZE) 6144 10 32 4900 32 32 proto.mr.fixed

makedvh: makedvh.c
	cc -o32 makedvh.c -o makedvh

#
# Note: If you want dprm.DBG on the volume header add
#    		$(ARCS)/IP30prom/$(PRODUCT).O/dprom.DBG
#       after the last depend line and add
#		$(ARCS)/IP30prom/$(PRODUCT).O/dprom.DBG dprm.DBG
#       after the last rule. Remember to add \'s previous lines also ...
#	(please refer to stand/arcs/IP30prom/README_dprom.DBG for more info)
#
# Note: If you want ide.DBG on the volume header add
#               $(ARCS)/ide/$(PRODUCT).O/shell.ide.DBG
#	after the last depend line and add
#		$(ARCS)/ide/$(PRODUCT).O/shell.ide.DBG ide.DBG
#	after the last rule. Remember to add \'s previous lines also ...
#	(please refer to stand/arcs/IP30prom/sable/README_ide.DBG for more info)
#
dvh: makedvh Makefile \
		$(ARCS)/sash/BE64.O/sash.stripped \
		$(ARCS)/symmon/$(PRODUCT).O/symmon.stripped \
		$(ARCS)/ide/$(PRODUCT).O/shell.ide.stripped
	@makedvh dvh part=8,0x2000 part=0,$(SIZE) part=1,$(SWAP) \
		$(ARCS)/sash/BE64.O/sash.stripped sash \
		$(ARCS)/symmon/$(PRODUCT).O/symmon.stripped symmon \
		$(ARCS)/ide/$(PRODUCT).O/shell.ide.stripped ide

sinclude Makedepend.rootdev

clobber : clean
	rm -rf RootDev
	
clean :
	rm -rf rootdev proto.mr.fixed makedvh Makedepend.rootdev dvh

.FORCE:
